#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TLDR_DIR="${TLDR_DIR:-./tldr}"
OUTPUT_DIR="${OUTPUT_DIR:-./pages}"
PARALLEL_JOBS="${PARALLEL_JOBS:-$(nproc 2>/dev/null || echo 4)}"

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Convert tldr-pages to Arsenal .cheat format.

Options:
    -t, --tldr-dir DIR      Path to tldr repo (default: ./tldr)
    -o, --output-dir DIR    Output directory (default: ./pages)
    -j, --jobs N            Parallel jobs (default: auto)
    -h, --help              Show this help

Example:
    git clone https://github.com/tldr-pages/tldr.git
    $(basename "$0") -t ./tldr -o ./pages
EOF
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -t|--tldr-dir) TLDR_DIR="$2"; shift 2 ;;
        -o|--output-dir) OUTPUT_DIR="$2"; shift 2 ;;
        -j|--jobs) PARALLEL_JOBS="$2"; shift 2 ;;
        -h|--help) usage; exit 0 ;;
        *) echo "Unknown option: $1"; usage; exit 1 ;;
    esac
done

if [[ ! -d "$TLDR_DIR/pages" ]]; then
    echo "Error: tldr repo not found at $TLDR_DIR"
    echo "Clone it first: git clone https://github.com/tldr-pages/tldr.git"
    exit 1
fi

sanitize_variables() {
    python3 "$SCRIPT_DIR/trans.py"
}

format_markdown() {
    grep -E '^[-`]' \
        | sed -E 's/:$//' \
        | sed 's/^\-/#/' \
        | sed -E 's/^`(.*)` *$/\1\'$'\n/g' \
        | sanitize_variables
}

tags_from_filename() {
    local file="$1"
    echo "$file" \
        | sed -E "s|.*${TLDR_DIR}/pages/||" \
        | sed 's/\.md$//' \
        | tr '/' ' ' \
        | awk '{ for (i=NF; i>1; i--) printf("%s ",$i); print $1; }' \
        | sed 's/ /, /g'
}

format_markdown_file() {
    local filename="$1"
    local tags
    tags=$(tags_from_filename "$filename")
    
    echo "; Extracted from https://github.com/tldr-pages/tldr"
    echo "; Source: ${filename#$TLDR_DIR/}"
    echo
    echo "% $tags"
    echo
    format_markdown < "$filename"
}

export_markdown() {
    local filename="$1"
    local out
    out=$(echo "$filename" | sed "s|^${TLDR_DIR}/|${OUTPUT_DIR}/|" | sed 's/\.md$/.cheat/')
    
    mkdir -p "$(dirname "$out")" 2>/dev/null || true
    format_markdown_file "$filename" > "$out"
}

export -f sanitize_variables format_markdown tags_from_filename format_markdown_file export_markdown
export SCRIPT_DIR TLDR_DIR OUTPUT_DIR

rm -rf "$OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR"

mapfile -t files < <(find "$TLDR_DIR/pages" -iname '*.md' -type f)
total=${#files[@]}
count=0
failed=0

echo "Converting $total tldr pages to .cheat format..."

for f in "${files[@]}"; do
    ((count++)) || true
    if export_markdown "$f" 2>/dev/null; then
        printf "\r[%d/%d] Converted: %s" "$count" "$total" "$(basename "$f" .md)"
    else
        ((failed++)) || true
        printf "\r[%d/%d] Failed: %s\n" "$count" "$total" "$(basename "$f" .md)"
    fi
done

echo
echo "Done: $((total - failed)) converted, $failed failed"
echo "Output: $OUTPUT_DIR"
